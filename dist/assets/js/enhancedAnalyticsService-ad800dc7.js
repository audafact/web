import{E as e,A as t}from"./index-a73b4fa8.js";import"./audio-0ea8d21d.js";import"./vendor-b17dff21.js";import"./auth-86c3050d.js";import"./ui-e2671ff1.js";class r{static instance;metrics=new Map;observers=new Map;analytics;isEnabled=!1;constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}enable(){this.isEnabled||(this.isEnabled=!0,this.initializeObservers())}disable(){this.isEnabled&&(this.isEnabled=!1,this.disposeObservers())}disposeObservers(){this.observers.forEach(e=>e.disconnect()),this.observers.clear()}initializeObservers(){if("PerformanceObserver"in window&&this.isEnabled){try{const e=new PerformanceObserver(e=>{for(const t of e.getEntries())"navigation"===t.entryType&&this.handleNavigationTiming(t)});e.observe({entryTypes:["navigation"]}),this.observers.set("navigation",e)}catch(e){}try{const e=new PerformanceObserver(e=>{for(const t of e.getEntries())"paint"===t.entryType&&this.handlePaintTiming(t)});e.observe({entryTypes:["paint"]}),this.observers.set("paint",e)}catch(e){}try{const e=new PerformanceObserver(e=>{for(const t of e.getEntries())"resource"===t.entryType&&this.handleResourceTiming(t)});e.observe({entryTypes:["resource"]}),this.observers.set("resource",e)}catch(e){}}}handleNavigationTiming(e){const t={demoLoadTime:e.loadEventEnd-e.loadEventStart,timeToInteractive:e.domInteractive-e.fetchStart,firstContentfulPaint:e.domContentLoadedEventEnd-e.fetchStart};this.trackMetrics("navigation",t)}handlePaintTiming(e){"first-paint"===e.name?this.trackMetric("firstPaint",e.startTime):"first-contentful-paint"===e.name&&this.trackMetric("firstContentfulPaint",e.startTime)}handleResourceTiming(e){(e.name.includes(".wav")||e.name.includes(".mp3"))&&this.trackMetric("audioLoadTime",e.duration)}trackMetric(e,t,r={}){const i={metric:e,value:t,timestamp:Date.now(),sessionId:this.getSessionId(),userId:this.getCurrentUserId(),userTier:this.getCurrentUserTier(),context:r};this.storeMetric(i),this.analytics&&this.analytics.track("performance_metric",i)}trackMetrics(e,t,r={}){Object.entries(t).forEach(([t,i])=>{this.trackMetric(`${e}_${t}`,i,r)})}startTimer(e){const t=performance.now();return()=>{const r=performance.now()-t;this.trackMetric(e,r)}}storeMetric(e){try{const t=JSON.parse(localStorage.getItem("performance_metrics")||"[]");t.push(e),t.length>100&&t.splice(0,t.length-100),localStorage.setItem("performance_metrics",JSON.stringify(t))}catch(t){}}getCurrentUserId(){return localStorage.getItem("user_id")||void 0}getCurrentUserTier(){return localStorage.getItem("user_tier")||"guest"}getSessionId(){return localStorage.getItem("session_id")||`session_${Date.now()}`}getMetrics(){try{return JSON.parse(localStorage.getItem("performance_metrics")||"[]")}catch(e){return[]}}clearMetrics(){try{localStorage.removeItem("performance_metrics")}catch(e){}}setAnalyticsService(e){this.analytics=e}}class i{static instance;pendingEvents=[];isOnline=navigator.onLine;retryInterval=5e3;maxRetries=3;retryTimer;constructor(){this.loadPendingEvents(),this.setupNetworkListeners(),this.startRetryTimer()}static getInstance(){return i.instance||(i.instance=new i),i.instance}setupNetworkListeners(){window.addEventListener("online",()=>{this.isOnline=!0,this.processPendingEvents()}),window.addEventListener("offline",()=>{this.isOnline=!1})}startRetryTimer(){this.retryTimer=setInterval(()=>{this.isOnline&&this.pendingEvents.length>0&&this.processPendingEvents()},this.retryInterval)}queueEvent(e,t){const r={event:e,properties:t,timestamp:Date.now(),sessionId:this.getSessionId(),userId:this.getCurrentUserId(),userTier:this.getCurrentUserTier(),retryCount:0,maxRetries:this.maxRetries};this.pendingEvents.push(r),this.savePendingEvents(),this.isOnline&&this.processPendingEvents()}async processPendingEvents(){const e=[...this.pendingEvents];for(const r of e)try{await this.sendEvent(r),this.pendingEvents=this.pendingEvents.filter(e=>e!==r),this.savePendingEvents()}catch(t){r.retryCount++,r.retryCount>=r.maxRetries&&(this.pendingEvents=this.pendingEvents.filter(e=>e!==r),this.savePendingEvents())}}async sendEvent(e){const t=await fetch("/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Analytics API returned ${t.status}`)}loadPendingEvents(){try{const e=localStorage.getItem("pending_analytics_events");e&&(this.pendingEvents=JSON.parse(e))}catch(e){this.pendingEvents=[]}}savePendingEvents(){try{localStorage.setItem("pending_analytics_events",JSON.stringify(this.pendingEvents))}catch(e){}}getSessionId(){return localStorage.getItem("session_id")||`session_${Date.now()}`}getCurrentUserId(){return localStorage.getItem("user_id")||void 0}getCurrentUserTier(){return localStorage.getItem("user_tier")||"guest"}getPendingEventCount(){return this.pendingEvents.length}clearPendingEvents(){this.pendingEvents=[],this.savePendingEvents()}destroy(){this.retryTimer&&clearInterval(this.retryTimer)}}class n{static instance;reliabilityService=null;performanceMonitor=null;errorMonitor=null;analyticsService=null;isInitialized=!1;constructor(){}static getInstance(){return n.instance||(n.instance=new n),n.instance}async initialize(){this.isInitialized||(this.reliabilityService=i.getInstance(),this.performanceMonitor=r.getInstance(),this.errorMonitor=e.getInstance(),this.analyticsService=t.getInstance(),this.performanceMonitor&&this.performanceMonitor.setAnalyticsService(this),this.errorMonitor&&this.errorMonitor.setAnalyticsService(this),this.isInitialized=!0)}async track(e,t={}){await this.initialize();const r={...t,timestamp:Date.now(),sessionId:this.getSessionId(),userId:this.getCurrentUserId(),userTier:this.getCurrentUserTier(),url:window.location.href,userAgent:navigator.userAgent,screenSize:`${screen.width}x${screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`,networkStatus:navigator.onLine?"online":"offline"};this.reliabilityService&&this.reliabilityService.queueEvent(e,r),this.performanceMonitor&&this.performanceMonitor.trackMetric("analytics_event_sent",1,{event:e})}async trackPerformance(e,t,r={}){await this.initialize(),this.performanceMonitor&&this.performanceMonitor.trackMetric(e,t,r)}async trackError(e,t,r={}){await this.initialize(),this.errorMonitor&&this.errorMonitor.captureError(e,t,r)}async trackCustomError(e,t,r="medium"){await this.initialize(),this.errorMonitor&&this.errorMonitor.captureCustomError(e,t,r)}async startPerformanceTimer(e){return await this.initialize(),this.performanceMonitor?this.performanceMonitor.startTimer(e):()=>{}}getSessionId(){return localStorage.getItem("session_id")||`session_${Date.now()}`}getCurrentUserId(){return localStorage.getItem("user_id")||void 0}getCurrentUserTier(){return localStorage.getItem("user_tier")||"guest"}getHealthStatus(){return{pendingEvents:this.reliabilityService?.getPendingEventCount()||0,errorRate:this.errorMonitor?.getErrorRate()||0,isOnline:navigator.onLine,lastError:this.errorMonitor?.getErrors()[this.errorMonitor?.getErrors().length-1],performanceMetrics:this.performanceMonitor?.getMetrics()||[]}}getPerformanceMetrics(){return this.performanceMonitor?.getMetrics()||[]}getErrors(){return this.errorMonitor?.getErrors()||[]}clearPerformanceMetrics(){this.performanceMonitor?.clearMetrics()}clearErrors(){this.errorMonitor?.clearErrors()}clearPendingEvents(){this.reliabilityService?.clearPendingEvents()}destroy(){this.reliabilityService?.destroy()}}export{n as EnhancedAnalyticsService};
//# sourceMappingURL=enhancedAnalyticsService-ad800dc7.js.map
